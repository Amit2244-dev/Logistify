<div class="fixed inset-0 flex items-center justify-center bg-black/50 z-[100]">
  <div class="relative bg-white shadow-lg flex flex-col
           w-full h-full rounded-none
           md:rounded-[10px] md:w-full md:max-w-[60vw] md:h-[80vh] md:max-h-[95vh]">

    <!-- HEADER -->
    <div class="flex justify-between items-center shadow-sm p-3 sticky top-0 z-10">
      <!-- Mobile: Back Arrow -->
      <button type="button" class="block md:hidden" (click)="onClose()">
        <mat-icon>arrow_back</mat-icon>
      </button>

      <h2 class="text-[16px] font-semibold text-center flex-1">
        {{ mode === 'view' ? 'View Summary' : 'Create Summary' }}
      </h2>

      <!-- Desktop: Close Button -->
      <button type="button" class="hidden md:block" (click)="onClose()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- CONTENT -->
    <div class="flex-1 overflow-y-auto p-6">
      <form [formGroup]="createSummary" (ngSubmit)="onSubmit()" class="space-y-6">

        <!-- User & Email Account -->
        <div class="flex flex-col md:flex-row gap-6">
          <!-- User -->
          <div class="!w-full">
            <mat-form-field appearance="fill" class="!w-full">
              <mat-label>{{ mode === 'view' ? 'User Account' : 'Select User Account' }}</mat-label>
              <ng-container *ngIf="mode === 'view'; else selectUser">
                <input matInput [value]="initialData.userAccount" readonly>
              </ng-container>
              <ng-template #selectUser>
                <mat-select formControlName="userAccount" (selectionChange)="onUserAccountSelect($event.value)"
                  (infiniteScroll)="loadMoreUsers()" [complete]="userAccountsComplete" msInfiniteScroll>
                  <mat-option *ngFor="let u of filteredUserAccounts" [value]="u">{{ u.viewValue }}</mat-option>
                </mat-select>
              </ng-template>
            </mat-form-field>
            <mat-error
              *ngIf="createSummary.get('userAccount')?.hasError('required') && createSummary.get('userAccount')?.touched">
              User account is required
            </mat-error>
          </div>

          <!-- Email -->
          <div class="relative !w-full">
            <mat-form-field appearance="fill" class="!w-full">
              <mat-label>{{ mode === 'view' ? 'Email Account' : 'Select Email Account' }}</mat-label>
              <ng-container *ngIf="mode === 'view'; else selectEmail">
                <input matInput [value]="initialData.emailAccount" readonly>
              </ng-container>
              <ng-template #selectEmail>
                <mat-select formControlName="emailAccount">
                  <mat-option *ngFor="let e of filteredEmailAccounts" [value]="e.value">{{ e.viewValue }}</mat-option>
                </mat-select>
              </ng-template>
            </mat-form-field>
            @if (!filteredEmailAccounts.length && !createSummary.get('userAccount')?.hasError('required') &&
            createSummary.get('userAccount')?.touched) {
            <mat-error>No email account connected yet for this user</mat-error>
            } @else {
            <mat-error
              *ngIf="createSummary.get('emailAccount')?.hasError('required') && createSummary.get('emailAccount')?.touched">
              Email account is required
            </mat-error>
            }
            <div *ngIf="loading" class="flex justify-center absolute right-7 top-[18px]">
              <mat-spinner [diameter]="25"></mat-spinner>
            </div>
          </div>
        </div>

        <!-- Date Selection -->
        <div class="mb-6">
          <h3 class="text-[16px] font-semibold mb-2">Summary Date</h3>
          <div class="bg-gray-100 rounded p-4 text-sm text-gray-800 leading-relaxed">

            <!-- Create Mode -->
            @if (mode !== 'view') {
            <div class="flex flex-col md:flex-row gap-4 items-center">
              <mat-form-field appearance="fill" class="!w-full">
                <mat-label>Summary Date</mat-label>
                <mat-select [formControl]="dateOptionControl">
                  <mat-option value="today">Today</mat-option>
                  <mat-option value="yesterday">Yesterday</mat-option>
                  <mat-option value="last7days">Custom Days</mat-option>
                  <mat-option value="custom">Custom Date</mat-option>
                </mat-select>
              </mat-form-field>

              <!-- Last 7 Days -->
              <mat-form-field appearance="fill" class="!w-full" *ngIf="dateOptionControl.value === 'last7days'">
                <mat-label>Select a Day</mat-label>
                <mat-select [formControl]="daysControl">
                  <mat-option *ngFor="let d of last7Days" [value]="d">{{ d }}</mat-option>
                </mat-select>
              </mat-form-field>

              <!-- Custom Date -->
              <mat-form-field appearance="fill" class="w-full" *ngIf="dateOptionControl.value === 'custom'">
                <mat-date-range-input [formGroup]="dateRange" [rangePicker]="picker">
                  <input matStartDate formControlName="start" placeholder="Start date" matInput />
                  <input matEndDate formControlName="end" placeholder="End date" matInput />
                </mat-date-range-input>
                <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-date-range-picker #picker></mat-date-range-picker>
              </mat-form-field>
            </div>
            }

            <!-- View Mode -->
            <div class="gap-6" *ngIf="mode === 'view'">
              <mat-form-field appearance="fill" class="!w-full">
                <mat-label>Start Date - End Date</mat-label>
                <input matInput [value]="
                  (initialData.range?.startDate | date:'dd MMM yyyy') +
                  ' - ' +
                  (initialData.range?.endDate | date:'dd MMM yyyy')
                " readonly />
              </mat-form-field>
            </div>

            <!-- Time Window -->
            <div class="flex flex-col md:flex-row gap-6 pt-4 items-center w-full">
              <div class="w-full">
                <mat-form-field appearance="fill" class="w-full">
                  <mat-label>Start Time</mat-label>
                  <ng-container *ngIf="mode === 'view'">
                    <input matInput [value]="initialData.timeWindow?.startTime" readonly>
                  </ng-container>
                  <ng-container *ngIf="mode === 'create'">
                    <input matInput [matTimepicker]="startPicker" placeholder="Select start time"
                      formControlName="startTime" />
                  </ng-container>
                  <mat-timepicker-toggle matSuffix [for]="startPicker"></mat-timepicker-toggle>
                  <mat-timepicker #startPicker></mat-timepicker>
                </mat-form-field>
              </div>
              <div class="w-full">
                <mat-form-field appearance="fill" class="w-full">
                  <mat-label>End Time</mat-label>
                  <ng-container *ngIf="mode === 'view'">
                    <input matInput [value]="initialData.timeWindow?.endTime" readonly>
                  </ng-container>
                  <ng-container *ngIf="mode === 'create'">
                    <input matInput [matTimepicker]="endPicker" placeholder="Select end time"
                      formControlName="endTime" />
                  </ng-container>
                  <mat-timepicker-toggle matSuffix [for]="endPicker"></mat-timepicker-toggle>
                  <mat-timepicker #endPicker></mat-timepicker>
                </mat-form-field>
                <mat-error *ngIf="createSummary.hasError('timeRangeInvalid')">
                  End time must be greater than start time
                </mat-error>
              </div>
            </div>
          </div>
        </div>

        <!-- Summary (View Mode) -->
        <div class="mb-6" *ngIf="mode === 'view'">
          <h3 class="text-[16px] font-semibold mb-2">Summary</h3>
          <div class="bg-gray-100 rounded p-4 text-sm text-gray-800 leading-relaxed">
            <span class="text-[13px]">{{ initialData.aiSummaryResponse }}</span>
          </div>
        </div>

        <!-- Submit -->
        <div class="text-center mt-4" *ngIf="mode === 'create'">
          <button type="submit"
            class="h-10 px-4 rounded-[4px] flex justify-center items-center cursor-pointer bg-[#9810fa] text-white w-full md:w-auto">
            Generate
          </button>
        </div>
      </form>
    </div>

    <!-- LOADING -->
    <div *ngIf="isLoading" class="flex justify-center items-center absolute inset-0 bg-[#33333399]">
      <mat-spinner [diameter]="50"></mat-spinner>
    </div>
  </div>
</div>